{{ if .Get "id" }}
  {{/*
    ----------------------------------------------------------------------------
    If the shortcode has an id, split all id values into an array and render
    the figure for each into a figure group
    ----------------------------------------------------------------------------
  */}}

  {{ $idstring := replace (.Get "id") " " "" }}
  {{ $idlist := split $idstring "," }}

  <figure class="quire-figure quire-figure--group {{ with .Get "class" }}{{ . }}{{ end }}">
    {{ range $idlist }}
    {{ $x := . | string }}

    {{ range where $.Site.Data.figures.figure_list "id" "eq" $x }}
    {{ $.Scratch.Add "figCount" 1 }}

    <figure class="quire-figure--group__item"
            id="{{ .id }}">

      {{ if .media_id }}

        {{ if and (ne .media_type "youtube") (ne .media_type "vimeo") }}

          <div class="quire-error message is-danger">
            <div class="message-header">
              <strong>SHORTCODE ERROR: q-figure-group</strong>
            </div>
            <div class="message-body">
              <p>One of your figures in this group is missing the <code>media_type</code> attribute, which must be included in your <code>data/figures.yml</code> file for this figure <code>id</code>, and must be either "youtube" or "vimeo".</p>
  <pre>
  - id: "3.1"
  media_id: VYqDpNmnu8I
  media_type: youtube
  </pre>
            </div>
          </div>

        {{ else }}

          <div class="quire-figure__video-wrapper{{ if .aspect_ratio }}--{{ .aspect_ratio }}{{ else }}--widescreen{{ end }}">

            {{ if eq .media_type "youtube" }}
              <iframe class="quire-figure__video" src="https://www.youtube-nocookie.com/embed/{{ .media_id }}?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen></iframe>
            {{ else if eq .media_type "vimeo" }}
              <iframe class="q-figure__video" src="https://player.vimeo.com/video/{{ .media_id }}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>
            {{ end }}

            <div class="quire-figure__video-fallback">
            {{ if .src }}
              <img src="/{{ $.Site.Params.imageDir }}{{ $.Site.Params.figureSubDir }}{{ .src }}" alt="{{ if $.Get "alt" }}{{ $.Get "alt" }}{{ else if .alt }}{{ .alt }}{{ end }}" />
            {{ else }}
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 36" fill="darkgray">
                <path  d="M41.9,13.8C42,15.2,42,16.6,42,18s0,2.8-0.1,4.2c0,0.9-0.3,1.6-0.8,2.2s-1.2,0.9-2.1,0.9c-2,0.1-4.3,0.2-7,0.2 s-5-0.1-7-0.2c-0.8,0-1.5-0.3-2.1-0.9s-0.8-1.4-0.8-2.2C22,20.8,22,19.4,22,18c0-0.9,0.1-2.3,0.2-4.2c0-0.9,0.3-1.6,0.8-2.2 s1.2-0.9,2-0.9c1.9-0.1,4.1-0.2,6.6-0.2H32h0.4c2.5,0,4.7,0.1,6.6,0.2c0.8,0,1.5,0.3,2.1,0.9S41.9,12.9,41.9,13.8z M30.1,21.8 l5.7-3.8l-5.7-3.9V21.8z"/>
                <path d="M0,0v36h64V0H0z M63,35H1V1h62V35z"/>
              </svg>
            {{ end }}
            </div>

          </div>

        {{ end }}

      {{ else }}

        <img class="quire-figure__image"
          src="/{{ $.Site.Params.imageDir }}{{ $.Site.Params.figureSubDir }}{{ .src }}"
          alt="{{ if $.Get "alt" }}{{ $.Get "alt" }}{{ else if .alt }}{{ .alt }}{{ end }}" />

      {{ end }}

      {{ if $.Get "caption" }}

          {{ if or (eq ($.Get "label") "true" ) (and (eq $.Site.Params.figureLabels true) (ne ($.Get "label") "false" )) }}
            <span class="quire-figure__label">
            {{ if $.Get "label_text" }}
              {{ $.Get "label_text" | markdownify }}
            {{ else if .label_text }}
              {{ .label_text | markdownify }}
            {{ else }}
              {{ $.Site.Params.figureLabelsTextBefore }}{{ .id }}
            </span>
            {{ end }}
          {{ end }}

      {{ else }}
      <figcaption class="quire-figure__caption">

          {{ if or (eq ($.Get "label") "true" ) (and (eq $.Site.Params.figureLabels true) (ne ($.Get "label") "false" )) }}
            <span class="quire-figure__label">
            {{ if $.Get "label_text" }}
              {{ $.Get "label_text" | markdownify }}
            {{ else if .label_text }}
              {{ .label_text | markdownify }}
            {{ else }}
              {{ $.Site.Params.figureLabelsTextBefore }}{{ .id }}{{ $.Site.Params.figureLabelsTextAfter }}
            </span>
            {{ end }}
          {{ end }}

          {{ if $.Get "caption" }}{{ $.Get "caption" | markdownify }}
          {{ else if .caption }}{{ .caption | markdownify }}{{ end }}

          {{- if eq .media_type "youtube" }}
            <span class="quire-figure__video-fallback__text">Watch the video at <a href="https://youtu.be/{{ .media_id }}">https://youtu.be/{{ .media_id }}</a>.</span>
          {{- end -}}
          {{- if eq .media_type "vimeo" }}
            <span class="quire-figure__video-fallback__text">Watch the video at <a href="https://vimeo.com/{{ .media_id }}">https://vimeo.com/{{ .media_id }}</a>.</span>
          {{- end -}}

          {{ if $.Get "credit" }}
            <span class="quire-figure__credit">{{ $.Get "credit" | markdownify }}</span>
          {{ else if .credit }}
            <span class="quire-figure__credit">{{ .credit | markdownify }}</span>
          {{ end }}

      </figcaption>
      {{ end }}
    </figure>
    {{ end }}

    {{ end }}

    {{ if ne (len $idlist) ($.Scratch.Get "figCount") }}
      {{/*
        ------------------------------------------------------------------------
        If after ranging through figure.yml, the count of figures rendered
        is not equal to the count of IDs supplied, post error message
        ------------------------------------------------------------------------
      */}}
      <div class="quire-error message is-danger">
        <div class="message-header">
          <strong>SHORTCODE ERROR: q-figure-group</strong>
        </div>
        <div class="message-body">
          <p>One or more of the <code>id</code> values supplied in this shortcode do not match any corresponding <code>id</code> values in your <code>data/figures.yml</code> file. Or, the <code>id</code> values were not fully comma separated. Values supplied were:</p>
          <pre>id="{{ .Get "id" }}"</pre>
        </div>
      </div>
    {{ end }}

    {{ with .Get "caption" }}
    <figcaption class="quire-figure--group__caption">
      {{ . | markdownify }}
    </figcaption>
    {{ end }}

  </figure>

{{ else }}
  {{/*
    ----------------------------------------------------------------------------
    If the shortcode has no id, post an error message.
    ----------------------------------------------------------------------------
  */}}

  <div class="quire-error message is-danger">
    <div class="message-header">
      <strong>SHORTCODE ERROR: q-figure-group</strong>
    </div>
    <div class="message-body">
      <p>This shortcode must include one or more values for <code>id</code> that match corresponding <code>id</code> values in your <code>data/figures.yml</code> file.</p>
      <pre>&#123;&#123;< q-figure-group id="3.1, 3.2, 3.3" >&#125;&#125;</pre>
    </div>
  </div>

{{ end }}
