{{ if isset $.Site.Params "imagedir" }}
{{ $.Scratch.Set "imageDir" $.Site.Params.imageDir }}
{{ else }}
{{ $.Scratch.Set "imageDir" "" }}
{{ end }}

{{ $errorBadId := dict "shortcode" "q-figure" "message" "The supplied value for `id` does not match an `id` value in your `data/figures.yml` file. Or, if you are not using a `data/figures.yml` file, a value for `src` should also be included in the shortcode, and should match the filename of an image file in your `static/img` directory." "example" "{{< q-figure id=&#34;3.1&#34; >}}<br /><br />{{< q-figure id=&#34;3.1&#34; src=&#34;fig-3-1-duchamp.jpg&#34; >}}" }}

{{ $errorNoMediaType := dict "shortcode" "q-figure" "message" "For multimedia figures, the `media_type` attribute must be included in your `data/figures.yml` file for this figure `id`, and must be either “youtube”, “vimeo” or “website”." "example" "- id: &#34;3.1&#34;<br />  media_id: &#34;VYqDpNmnu8I&#34;<br />  media_type: &#34;youtube&#34;" }}

{{ $errorNoSourceNoId := dict "shortcode" "q-figure" "message" "This shortcode must include a value for `src` that matches the filename of an image in your `static/img` directory; or a value for `id` that matches an `id` value in your `data/figures.yml` file." "example" "{{< q-figure id=&#34;3.1&#34; >}}<br /><br />{{< q-figure id=&#34;3.1&#34; src=&#34;fig-3-1-duchamp.jpg&#34; >}}" }}

{{ if .Get "src" }}

{{ if .Get "geojson"  }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure">
  <div class="q-figure__wrapper">
    <a 
    href="#map-{{ $Id }}"     
    class='inline popup'
    data-type="leaflet" 
    data-caption='{{ .Get "caption" | markdownify | safeHTML }}'>
    <img
      class="quire-figure__image" 
      src='{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}'
      alt='{{ with .Get "alt" }}{{ . }}{{ end }}' />
      </a>
      <figure id="map-{{ $Id }}" class="quire-figure leaflet-outer-wrapper mfp-hide"><div id="js-map-{{ now.UnixNano }}" class="quire-map leaflet-inner-wrapper inset"{{ with .Get "lat" }}data-lat="{{.}}"{{ end }}{{ with .Get "long" }}data-long="{{.}}"{{ end }}{{ if .Get "geojson" }}data-geojson="{{ .Site.BaseURL }}{{ .Get "geojson" }}"{{ end }}></div></figure>
  </div>
</figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-map-{{ now.UnixNano }}" class="no-popup-quire-map quire-map inset" {{ with .Get "lat" }} data-lat="{{.}}" {{ end }}
    {{ with .Get "long" }} data-long="{{.}}" {{ end }} {{ if .Get "geojson" }} data-geojson="{{ .Site.BaseURL }}{{ .Get "geojson" }}"
    {{ end }}></div>
    {{ if .Get "caption" }} <figcaption>{{ .Get "caption" | markdownify | safeHTML }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ else if eq .media_type "iiif"  }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure">
  <div class="q-figure__wrapper">
    <a
    href="#iiif-{{ $Id }}" 
    class='inline popup'
    data-type='inline' 
    {{ if .Get "caption" }}  data-caption='{{ .Get "caption" | markdownify | safeHTML }}' {{ end }}>
      <img
      class="quire-figure__image" 
      src='{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}'
      alt='{{ with .Get "alt" }}{{ . }}{{ end }}' />
      <figure id="iiif-{{ $Id }}" class="quire-figure leaflet-outer-wrapper"><div id="js-deepzoom-{{ now.UnixNano }}" class="quire-deepzoom inset leaflet-inner-wrapper " aria-live="polite" role="application" aria-label="Zoomable image" data-image="{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}"></div></figure>
    </a>
  </div>
</figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-iiif-{{ now.UnixNano }}" 
 class="quire-deepzoom inset no-popup-quire-deepzoom" 
 aria-live="polite" 
 role="application" 
 aria-label="Zoomable image" 
 data-image='{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}'>
   </div>
   {{ if .Get "caption" }} <figcaption>{{ .Get "caption" | markdownify | safeHTML }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ else }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure">
  <div class="q-figure__wrapper">
    <a
    href="#deepzoom-{{ $Id }}" 
    class='inline popup'
    data-type='inline' 
    {{ if .Get "caption" }}  data-caption='{{ .Get "caption" | markdownify | safeHTML }}' {{ end }}>
      <img
      class="quire-figure__image" 
      src='{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}'
      alt='{{ with .Get "alt" }}{{ . }}{{ end }}' />
      <figure id="deepzoom-{{ $Id }}" class="quire-figure leaflet-outer-wrapper"><div id="js-deepzoom-{{ now.UnixNano }}" class="quire-deepzoom inset leaflet-inner-wrapper " aria-live="polite" role="application" aria-label="Zoomable image" data-image="{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}"></div></figure>
    </a>
  </div>
</figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-deepzoom-{{ now.UnixNano }}" 
 class="quire-deepzoom inset no-popup-quire-deepzoom" 
 aria-live="polite" 
 role="application" 
 aria-label="Zoomable image" 
 data-image='{{ with .Get "src"}}{{ printf "%s/%s" ($.Scratch.Get "imageDir") . | relURL }}{{ end }}'>
   </div>
   {{ if .Get "caption" }} <figcaption>{{ .Get "caption" | markdownify | safeHTML }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ end }}

{{ else if .Get "id" }}
{{/* -------------------- BEGIN ID BLOCK -------------------- */}}
{{/*
----------------------------------------------------------------------------
If the shortcode has an id, but no src, look for figures.yml document and
render the figure from matching values found ther
----------------------------------------------------------------------------
*/}}

{{ $x := .Get "id" | string }}
{{ $fig := len (where .Site.Data.figures.figure_list "id" "eq" $x) }}

{{ if eq $fig 0 }}
  {{ partial "error-message.html" $errorBadId }}
{{ else }}

{{/* -------------------- BEGIN FIGURE RANGE -------------------- */}}
{{ range where .Site.Data.figures.figure_list "id" "eq" $x }}

{{ if eq .media_type "map"  }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure">
    <div class="q-figure__wrapper">
      <a 
      href="#map-{{ $Id }}" 
      class='inline popup'
      data-type="inline"
      {{ if .caption }} data-caption='{{ .caption | markdownify | safeHTML }}' {{ end }}>
        <img
        class="quire-figure__image" 
        src='{{ printf "%s/%s" ($.Scratch.Get "imageDir") .src | relURL }}' />
        </a>
    </div>
    <figure id="map-{{ $Id }}" class="quire-figure leaflet-outer-wrapper mfp-hide"><div id="js-map-{{ now.UnixNano }}" class="quire-map leaflet-inner-wrapper inset" data-lat="{{ .lat }}"data-long="{{ .long }}" data-geojson="{{ .Site.BaseURL }}{{ .geojson }}"></div></figure>
  </figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-map-{{ now.UnixNano }}" 
  class="no-popup-quire-map quire-map inset" 
  data-lat="{{ .lat }}"
  data-long="{{ .long }}" 
  data-geojson="{{ .Site.BaseURL }}{{ .geojson }}"></div>
  {{ if .caption }} <figcaption>{{ .caption }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ else if eq .media_type "iiif"  }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure {{ .src }}">
  <div class="q-figure__wrapper">
    <a
    class='inline popup'
    href="#iiif-{{ $Id }}"
    data-type='inline'
    {{ if .caption }} data-caption='{{ .caption | markdownify | safeHTML }}' {{ end }}>
      <img
      class="quire-figure__image" 
      src='{{ printf "%s/%s" ($.Scratch.Get "imageDir") .src | relURL }}' />
    </a>
    <figure id="iiif-{{ $Id }}" 
    class="quire-figure leaflet-outer-wrapper mfp-hide">
    <div id="js-iiif-{{ now.UnixNano }}" class="quire-deepzoom inset leaflet-inner-wrapper" aria-live="polite" role="application" aria-label="Zoomable image" data-iiif="{{ .iiif }}" data-zoom="{{ .zoom_level }}"></div></figure>
  </div>
</figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-iiif-{{ now.UnixNano }}" 
 data-iiif="{{ .iiif }}" 
 data-zoom="{{ .zoom_level }}"
 class="no-popup-quire-deepzoom quire-deepzoom inset" 
 aria-live="polite" 
 role="application" 
 aria-label="Zoomable image">
   </div>
   {{ if .caption }} <figcaption>{{ .caption | markdownify | safeHTML }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ else }}

{{ if eq $.Site.Params.popup true }}

{{ $Id := now.UnixNano }}

<figure class="quire-figure {{ .src }}">
  <div class="q-figure__wrapper">
    <a
    href="#deepzoom-{{ $Id }}"
    class='inline popup'
    data-type='inline'
    {{ if .caption }} data-caption='{{ .caption | markdownify | safeHTML }}' {{ end }}>
      <img
      class="quire-figure__image" 
      src='{{ printf "%s/%s" ($.Scratch.Get "imageDir") .src | relURL }}' />
    </a>
    <figure id="deepzoom-{{ $Id }}" class="quire-figure leaflet-outer-wrapper mfp-hide"><div id="js-deepzoom-{{ now.UnixNano }}" class="quire-deepzoom inset leaflet-inner-wrapper " aria-live="polite" role="application" aria-label="Zoomable image" data-image="{{ printf "%s/%s" ($.Scratch.Get "imageDir") .src | relURL }}"></div></figure>
  </div>
</figure>

{{ else }}

<figure class="quire-figure">
  <div id="js-deepzoom-{{ now.UnixNano }}" 
 class="no-popup-quire-deepzoom  quire-deepzoom inset inline" 
 aria-live="polite" 
 role="application" 
 aria-label="Zoomable image" 
 data-image='{{ printf "%s/%s" ($.Scratch.Get "imageDir") .src | relURL }}'>
   </div>
   {{ if .caption }} <figcaption>{{ .caption | markdownify | safeHTML }}</figcaption> {{ end }}
</figure>

{{ end }}

{{ end }}

{{ end }}

{{ end }}

{{ end }}